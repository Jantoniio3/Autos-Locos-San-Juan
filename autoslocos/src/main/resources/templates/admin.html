<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="generator" content="Mobirise v6.0.5, mobirise.com">
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <link rel="shortcut icon" href="/assets/images/favicon.ico" type="image/x-icon">

    <title>Autos Locos San Juan</title>
    <link rel="stylesheet" href="/assets/web/assets/mobirise-icons2/mobirise2.css">
    <link rel="stylesheet" href="/assets/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="/assets/bootstrap/css/bootstrap-grid.min.css">
    <link rel="stylesheet" href="/assets/bootstrap/css/bootstrap-reboot.min.css">
    <link rel="stylesheet" href="/assets/parallax/jarallax.css">
    <link rel="stylesheet" href="/assets/dropdown/css/style.css">
    <link rel="stylesheet" href="/assets/socicon/css/styles.css">
    <link rel="stylesheet" href="/assets/theme/css/style.css">
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Onest:wght@400;700&display=swap&display=swap"
        as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript>
        <link rel="stylesheet"
            href="https://fonts.googleapis.com/css2?family=Onest:wght@400;700&display=swap&display=swap">
    </noscript>
    <link rel="preload" as="style" href="/assets/mobirise/css/mbr-additional.css?v=NzfGCw">
    <link rel="stylesheet" href="/assets/mobirise/css/mbr-additional.css?v=NzfGCw" type="text/css">
    <meta charset="UTF-8">
    <title>Panel de Administración</title>
    <link rel="stylesheet" href="/assets/bootstrap/css/bootstrap.min.css">
    <style>
        .admin-section { display: none; }
        .admin-section.active { display: block; }
    </style>
</head>
<body>

{{> header }}

<div class="container py-4">
    <!-- Navegación entre secciones -->
    <div class="mb-4 text-center">
        <button class="btn btn-primary me-2" onclick="showSection('vehiculos')">Vehículos inscritos</button>
        <button class="btn btn-secondary me-2" onclick="showSection('novedades')">Novedades</button>
        <button class="btn btn-secondary me-2" onclick="showSection('galeria')">Galería</button>
        <button class="btn btn-secondary" onclick="showSection('patrocinadores')">Patrocinadores</button>
    </div>

    <!-- Sección de vehículos -->
    <div id="vehiculos" class="admin-section active">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-12 content-head">
                    <div class="mbr-section-head mb-5">
                        <h3 class="mbr-section-title mbr-fonts-style align-center mb-0 display-2">
                            <strong>Vehículos Inscritos</strong>
                        </h3>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            {{#vehicles}}
            <div class="col-md-6 col-lg-4 mb-4">
                <div class="card h-100 shadow">
                    {{#photo}}
                    <img src="{{photo}}" class="card-img-top" style="object-fit:contain; height:220px; background-color:#f8f9fa;" id="vehicleImage-{{id}}">
                    {{/photo}}
                    {{^photo}}
                    <img src="/assets/images/car-placeholder.png" class="card-img-top" style="object-fit:contain; height:220px; background-color:#f8f9fa;">
                    {{/photo}}
                    <div class="card-body">
                        <h5 class="card-title">{{name}}</h5>
                        <p class="card-text"><strong>Piloto:</strong> {{driver}}</p>
                        {{#coDriver}}<p class="card-text"><strong>Copiloto:</strong> {{coDriver}}</p>{{/coDriver}}
                        {{#passenger1}}<p class="card-text"><strong>Pasajero 1:</strong> {{passenger1}}</p>{{/passenger1}}
                        {{#passenger2}}<p class="card-text"><strong>Pasajero 2:</strong> {{passenger2}}</p>{{/passenger2}}
                        {{#contactNumber}}<p class="card-text"><strong>Contacto:</strong> {{contactNumber}}</p>{{/contactNumber}}
                        
                        <!-- Botones de acción -->
                        <div class="d-flex justify-content-between mt-3">
                            {{#photo}}
                            <a href="{{photo}}" class="btn btn-outline-primary btn-sm" download="{{name}}-imagen.jpg">
                                <i class="bi bi-download"></i> Descargar Imagen
                            </a>
                            {{/photo}}
                            
                            <button class="btn btn-outline-danger btn-sm delete-vehicle" data-id="{{id}}">
                                <i class="bi bi-trash"></i> Eliminar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            {{/vehicles}}
            {{^vehicles}}
            <div class="col-12 text-center">
                <p>No hay vehículos inscritos.</p>
            </div>
            {{/vehicles}}
        </div>
    </div>

    <!-- Sección de novedades -->
    <div id="novedades" class="admin-section">
        <h2>Novedades</h2>
        <p>Formulario de novedades próximamente...</p>
    </div>

    <!-- Sección de galería -->
    <div id="galeria" class="admin-section">
        <h2>Galería</h2>
        <p>Formulario de galería próximamente...</p>
    </div>

    <!-- Sección de patrocinadores -->
    <div id="patrocinadores" class="admin-section">
        <h2>Patrocinadores</h2>
        <form id="sponsorForm" enctype="multipart/form-data" action="/addsponsors" method="post" class="mb-4">
            <input type="hidden" name="_csrf" value="{{_csrf.token}}">
            <div class="mb-3">
                <label for="sponsorName" class="form-label">Nombre del patrocinador</label>
                <input type="text" class="form-control" id="sponsorName" name="name" required>
            </div>
            <div class="mb-3">
                <label for="sponsorLogo" class="form-label">Logo (imagen)</label>
                <input type="file" class="form-control" id="sponsorLogo" name="logo" accept="image/*" required>
            </div>
            <button type="submit" class="btn btn-primary">Inscribir Patrocinador</button>
        </form>
        <div id="sponsorMessage"></div>
    </div>
</div>

{{> footer }}

<script>
    function showSection(sectionId) {
        const sections = document.querySelectorAll('.admin-section');
        sections.forEach(sec => sec.classList.remove('active'));

        document.getElementById(sectionId).classList.add('active');
    }
</script>

<script src="/assets/bootstrap/js/bootstrap.bundle.min.js"></script>
<script>
document.querySelectorAll('.delete-vehicle').forEach(button => {
    button.addEventListener('click', async function() {
        const vehicleId = this.dataset.id;
        if (!confirm('¿Eliminar este vehículo?')) return;

        // Leer el token CSRF de la cookie
        const csrfToken = document.cookie
            .split('; ')
            .find(row => row.startsWith('XSRF-TOKEN='))
            ?.split('=')[1];

        if (!csrfToken) {
            alert('No se encontró el token CSRF');
            return;
        }

        try {
            const response = await fetch('/deletevehicle', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-XSRF-TOKEN': csrfToken
                },
                body: new URLSearchParams({ id: vehicleId }),
                credentials: 'include'
            });

            if (!response.ok) {
                const error = await response.text();
                throw new Error(error || 'Error en la solicitud');
            }

            alert(await response.text());
            location.reload();
        } catch (error) {
            alert(error.message);
        }
    });
});
</script>
</body>
</html>
